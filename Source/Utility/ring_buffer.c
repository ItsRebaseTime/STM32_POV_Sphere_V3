/**********************************************************************************************************************
 * Includes
 *********************************************************************************************************************/
#include "ring_buffer.h"
/**********************************************************************************************************************
 * Private definitions and macros
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Private typedef
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Private constants
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Private variables
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Exported variables and references
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Prototypes of private functions
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Definitions of private functions
 *********************************************************************************************************************/
static void RB_AdvancePointer (rb_handle_t rb) {
    if (rb->full) {
        if (++(rb->tail) == rb->size) {
            rb->tail = 0;
        }
    }
    if (++(rb->head) == rb->size) {
        rb->head = 0;
    }
    rb->full = (rb->head == rb->tail);
}

static void RB_RetreatPointer (rb_handle_t rb) {
    rb->full = false;
    if (++(rb->tail) == rb->size) {
        rb->tail = 0;
    }
}
/**********************************************************************************************************************
 * Definitions of exported functions
 *********************************************************************************************************************/
rb_handle_t RB_Init (uint16_t size) {
    rb_handle_t rb = calloc(1, sizeof(rbuf_t));
    if (rb == NULL) {
        return NULL;
    }
    rb->buffer = calloc(size, sizeof(uint8_t));
    if (rb->buffer == NULL) {
        free(rb);
        return NULL;
    }
    rb->size = size;
    RB_Reset(rb);
    return rb;
}

void RB_Reset (rb_handle_t rb) {
    rb->head = 0;
    rb->tail = 0;
    rb->full = false;
}

void RB_Free (rb_handle_t rb) {
    free(rb);
    free(rb->buffer);
}

bool RB_IsFull (rb_handle_t rb) {
    return rb->full;
}

bool RB_IsEmpty (rb_handle_t rb) {
    return (!rb->full && (rb->head == rb->tail));
}

uint32_t RB_GetSize (rb_handle_t rb) {
    return rb->size;
}

uint32_t RB_GetFreeSpace (rb_handle_t rb) {
    uint32_t size = rb->size;
    if (!rb->full) {
        if (rb->head >= rb->tail) {
            size = (rb->head - rb->tail);
        }
        else {
            size = (rb->size + rb->head - rb->tail);
        }
    }
    return size;
}

void RB_Push (rb_handle_t rb, uint8_t data) {
    rb->buffer[rb->head] = data;
    RB_AdvancePointer(rb);
}

bool RB_Pop (rb_handle_t rb, uint8_t *data) {
    bool popped = false;
    if (!RB_IsEmpty(rb)) {
        *data = rb->buffer[rb->tail];
        RB_RetreatPointer(rb);
        popped = true;
    }
    return popped;
}
